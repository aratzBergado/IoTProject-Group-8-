<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>EcoSense Dashboard</title>

  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- DataTables CSS -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">

  <style>
    body { font-family: Arial, sans-serif; margin: 20px; max-width: 1400px; }
    header { display:flex; align-items:center; justify-content:space-between; margin-bottom:20px; flex-wrap: wrap; }
    .kpi { display:inline-block; padding:10px 14px; border-radius:8px; box-shadow:0 1px 3px rgba(0,0,0,0.1); margin-right:10px; margin-bottom:5px; }
    .alert { padding:10px; margin-bottom:8px; border-radius:6px; border-left:6px solid #d9534f; background:#fff6f6; }
    section { margin-bottom: 40px; }
    label { font-weight: bold; margin-right: 5px; }
  </style>
</head>
<body>

<header class="mb-4">
  <h1>EcoSense Dashboard</h1>
  <div>
    <span class="kpi" id="kpi-users">Usuarios: â€”</span>
    <span class="kpi" id="kpi-events">Eventos: â€”</span>
  </div>
</header>

<!-- Usuarios -->
<section>
  <h2>Usuarios</h2>
  <input type="text" id="user-filter" placeholder="Filtrar usuarios por nombre o email..." class="form-control mb-2" style="max-width:400px;">
  <div class="table-responsive">
    <table id="users-table" class="table table-striped table-bordered">
      <thead>
        <tr><th>Nombre</th><th>Email</th><th>Major/Dept</th><th>Nacionalidad/Rol</th></tr>
      </thead>
      <tbody id="users-body"></tbody>
    </table>
  </div>
</section>

<!-- Leaderboard -->
<section>
  <h2>Leaderboard</h2>
  <label>Filtrar por rol: </label>
  <select id="leaderboard-filter" class="form-select mb-2" style="max-width:200px;">
    <option value="">Todos</option>
    <option value="student">Estudiantes</option>
    <option value="faculty">Profesores</option>
  </select>
  <div class="table-responsive">
    <table id="leaderboard-table" class="table table-striped table-bordered">
      <thead><tr><th>Pos</th><th>Usuario</th><th>Puntos</th><th>Ãšltima actualizaciÃ³n</th></tr></thead>
      <tbody id="leaderboard-body"></tbody>
    </table>
  </div>
</section>

<!-- Sensores -->
<section>
  <h2>Alertas de sensores</h2>
  <label>Mostrar solo alertas: </label>
  <select id="sensor-filter" class="form-select mb-2" style="max-width:200px;">
    <option value="all">Todas</option>
    <option value="needs_action">Necesitan acciÃ³n</option>
  </select>
  <div id="sensors-alerts"></div>
</section>

<!-- Eventos -->
<section>
  <h2>Eventos recientes</h2>
  <label>Filtrar eventos: </label>
  <select id="event-filter" class="form-select mb-2" style="max-width:250px;">
    <option value="">Todos</option>
    <option value="litter_pickup">Recogida de basura</option>
    <option value="bin_full">Contenedor lleno</option>
    <option value="plant_watered">Planta regada</option>
  </select>
  <div id="events-list"></div>
</section>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<!-- jQuery y DataTables -->
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>

<script>
  // --- ConfiguraciÃ³n Firebase ---
  const firebaseConfig = {
    apiKey: "AIzaSyDrlSuQYTDcSD6JTEQ-kOVo4yATvZ2zO7I",
    authDomain: "proyecto-iot---grupo-8.firebaseapp.com",
    databaseURL: "https://proyecto-iot---grupo-8-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "proyecto-iot---grupo-8",
    storageBucket: "proyecto-iot---grupo-8.firebasestorage.app",
    messagingSenderId: "739127706120",
    appId: "1:739127706120:web:29fd24907c541e311607bd"
  };
  
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const rootRef = db.ref('/');

  rootRef.on('value', snapshot => {
    const data = snapshot.val() || {};

    // --- Render usuarios ---
    const usersBody = document.getElementById('users-body');
    usersBody.innerHTML = '';
    if(data.users) {
      Object.values(data.users).forEach(u=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${u.name||'-'}</td><td>${u.email||'-'}</td><td>${u.major||u.department||'-'}</td><td>${u.nationality||u.role||'-'}</td>`;
        usersBody.appendChild(tr);
      });
      $('#users-table').DataTable().draw(); // refrescar DataTable
      document.getElementById('kpi-users').textContent = 'Usuarios: ' + Object.keys(data.users).length;
    }

    // --- Render leaderboard ---
    const lbBody = document.getElementById('leaderboard-body');
    lbBody.innerHTML = '';
    if(data.leaderboard) {
      Object.entries(data.leaderboard)
        .sort((a,b)=> b[1].points - a[1].points)
        .forEach(([uid, lb], idx)=>{
          const userName = (data.users && data.users[uid] && data.users[uid].name) || uid;
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${idx+1}</td><td>${userName}</td><td>${lb.points}</td><td>${lb.last_update}</td>`;
          lbBody.appendChild(tr);
        });
      $('#leaderboard-table').DataTable().draw();
    }

    // --- Render sensores ---
    const sensorsDiv = document.getElementById('sensors-alerts');
    sensorsDiv.innerHTML = '';
    if(data.sensors) {
      Object.entries(data.sensors).forEach(([id, s])=>{
        let text = '';
        if(s.type==='plant_sensor' && s.water_needed) text = `ðŸŒ± ${id} necesita agua!`;
        else if(s.type==='smart_bin' && s.gas_status==='overflow') text = `ðŸ—‘ï¸ ${id} estÃ¡ lleno!`;
        if(text){
          const div = document.createElement('div');
          div.className = 'alert';
          div.textContent = text;
          sensorsDiv.appendChild(div);
        }
      });
    }

    // --- Render eventos ---
    const eventsDiv = document.getElementById('events-list');
    eventsDiv.innerHTML = '';
    if(data.events) {
      Object.values(data.events)
        .sort((a,b)=> new Date(b.timestamp)-new Date(a.timestamp))
        .forEach(ev=>{
          const div = document.createElement('div');
          div.className='alert';
          div.textContent = `${ev.type} â€” ${ev.user} â€” +${ev.points_awarded} pts â€” ${ev.location} â€” ${new Date(ev.timestamp).toLocaleString()}`;
          eventsDiv.appendChild(div);
        });
      document.getElementById('kpi-events').textContent = 'Eventos: ' + Object.keys(data.events).length;
    }
  });

  // --- Inicializar DataTables ---
  $(document).ready(function(){
    $('#users-table').DataTable({
      paging: true,
      searching: true,
      info: false,
      pageLength: 5,
      lengthChange: false,
      language: { search: "Buscar:", zeroRecords: "No se encontraron resultados" }
    });
    $('#leaderboard-table').DataTable({
      paging: true,
      searching: true,
      info: false,
      pageLength: 5,
      lengthChange: false,
      order: [[2,'desc']],
      language: { search: "Buscar:", zeroRecords: "No se encontraron resultados" }
    });

    // --- Filtros dinÃ¡micos ---
    $('#user-filter').on('keyup', function(){ $('#users-table').DataTable().search(this.value).draw(); });
    $('#leaderboard-filter').on('change', function(){
      const val = this.value;
      const table = $('#leaderboard-table').DataTable();
      if(val) table.column(1).search(val, true, false).draw();
      else table.search('').columns().search('').draw();
    });
    $('#sensor-filter').on('change', function(){
      const val = this.value;
      $('#sensors-alerts').children().each(function(){
        if(val==='needs_action'){
          if(!$(this).text().includes('necesita') && !$(this).text().includes('estÃ¡ lleno')) $(this).hide();
          else $(this).show();
        } else $(this).show();
      });
    });
    $('#event-filter').on('change', function(){
      const val = this.value;
      $('#events-list').children().each(function(){
        if(val && !$(this).text().includes(val)) $(this).hide();
        else $(this).show();
      });
    });
  });
</script>

</body>
</html>
