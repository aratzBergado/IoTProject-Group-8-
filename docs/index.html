<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EcoSense Dashboard</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- DataTables CSS -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css">

  <style>
    body { font-family: Arial, sans-serif; margin: 20px; max-width: 1200px; }
    header { display:flex; align-items:center; justify-content:space-between; margin-bottom:20px; }
    .kpi { display:inline-block; padding:10px 14px; border-radius:8px; box-shadow:0 1px 3px rgba(0,0,0,0.1); margin-right:10px; }
    .alert { padding:10px; margin-bottom:8px; border-radius:6px; border-left:6px solid #d9534f; background:#fff6f6; }
  </style>
</head>
<body>
  <header>
    <h1>EcoSense Dashboard</h1>
    <div>
      <span class="kpi" id="kpi-users">Usuarios: ‚Äî</span>
      <span class="kpi" id="kpi-events">Eventos: ‚Äî</span>
    </div>
  </header>

  <section>
    <h2>Usuarios</h2>
    <table id="users-table" class="table table-striped table-bordered">
      <thead>
        <tr><th>Nombre</th><th>Email</th><th>Major/Dept</th><th>Nacionalidad/Rol</th></tr>
      </thead>
      <tbody id="users-body"></tbody>
    </table>
  </section>

  <section>
    <h2>Leaderboard</h2>
    <table id="leaderboard-table" class="table table-striped table-bordered">
      <thead><tr><th>Pos</th><th>Usuario</th><th>Puntos</th><th>√öltima actualizaci√≥n</th></tr></thead>
      <tbody id="leaderboard-body"></tbody>
    </table>
  </section>

  <section>
    <h2>Alertas de sensores</h2>
    <div id="sensors-alerts"></div>
  </section>

  <section>
    <h2>Eventos recientes</h2>
    <div id="events-list"></div>
  </section>

  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <!-- DataTables JS -->
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <script>
    // --- Configuraci√≥n Firebase ---
    const firebaseConfig = {
      apiKey: "AIzaSyDrlSuQYTDcSD6JTEQ-kOVo4yATvZ2zO7I",
      authDomain: "proyecto-iot---grupo-8.firebaseapp.com",
      databaseURL: "https://proyecto-iot---grupo-8-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "proyecto-iot---grupo-8",
      storageBucket: "proyecto-iot---grupo-8.firebasestorage.app",
      messagingSenderId: "739127706120",
      appId: "1:739127706120:web:29fd24907c541e311607bd"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const rootRef = db.ref('/');

    rootRef.on('value', snapshot => {
      const data = snapshot.val() || {};

      // --- Render Usuarios ---
      const usersBody = document.getElementById('users-body');
      usersBody.innerHTML = '';
      if (data.users) {
        Object.values(data.users).forEach(u => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${u.name || '-'}</td><td>${u.email || '-'}</td><td>${u.major || u.department || '-'}</td><td>${u.nationality || u.role || '-'}</td>`;
          usersBody.appendChild(tr);
        });
        document.getElementById('kpi-users').textContent = 'Usuarios: ' + Object.keys(data.users).length;

        // Inicializar DataTable para usuarios
        $('#users-table').DataTable({
          destroy: true,
          paging: true,
          searching: true,
          info: false,
          pageLength: 5,
          lengthChange: false,
          language: { search: "Buscar:", zeroRecords: "No se encontraron resultados" }
        });
      }

      // --- Render Leaderboard ---
      const lbBody = document.getElementById('leaderboard-body');
      lbBody.innerHTML = '';
      if (data.leaderboard) {
        Object.entries(data.leaderboard)
          .sort((a,b)=> b[1].points - a[1].points)
          .forEach(([uid, lb], idx) => {
            const userName = (data.users && data.users[uid] && data.users[uid].name) || uid;
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${idx+1}</td><td>${userName}</td><td>${lb.points}</td><td>${lb.last_update}</td>`;
            lbBody.appendChild(tr);
          });

        // Inicializar DataTable para leaderboard
        $('#leaderboard-table').DataTable({
          destroy: true,
          paging: true,
          searching: true,
          info: false,
          pageLength: 5,
          lengthChange: false,
          order: [[2,'desc']],
          language: { search: "Buscar:", zeroRecords: "No se encontraron resultados" }
        });
      }

      // --- Render Sensores ---
      const sensorsDiv = document.getElementById('sensors-alerts');
      sensorsDiv.innerHTML = '';
      if (data.sensors) {
        Object.entries(data.sensors).forEach(([id, s]) => {
          let text = '';
          if (s.type === 'plant_sensor' && s.water_needed) text = `üå± ${id} necesita agua!`;
          else if (s.type === 'smart_bin' && s.gas_status === 'overflow') text = `üóëÔ∏è ${id} est√° lleno!`;
          if (text) {
            const div = document.createElement('div');
            div.className = 'alert';
            div.textContent = text;
            sensorsDiv.appendChild(div);
          }
        });
      } else sensorsDiv.textContent = 'Sin sensores activos';

      // --- Render Eventos ---
      const
