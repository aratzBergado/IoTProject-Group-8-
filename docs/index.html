<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EcoSense Dashboard Interactivo</title>

<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  body { font-family: 'Roboto', sans-serif; background:#f4f6f8; color:#333; margin:0; padding:20px; }
  header { display:flex; justify-content:space-between; flex-wrap:wrap; margin-bottom:30px; }
  h1 { font-size:2rem; color:#2c3e50; }

  .kpi-container { display:flex; flex-wrap:wrap; gap:15px; }
  .kpi { background:#fff; padding:15px 20px; border-radius:10px; box-shadow:0 3px 8px rgba(0,0,0,0.12); flex:1 1 150px; text-align:center; font-weight:500; }

  section { margin-bottom:30px; }
  h2 { margin-bottom:15px; color:#34495e; border-bottom:2px solid #ddd; padding-bottom:5px; }

  table { width:100%; border-collapse:collapse; background:#fff; border-radius:8px; overflow:hidden; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
  th, td { padding:12px 15px; text-align:left; }
  th { background:#2c3e50; color:#fff; }
  tr:nth-child(even) { background:#f9f9f9; }
  tr:hover { background:#e1f5fe; }

  .alert { padding:12px 15px; margin-bottom:10px; border-radius:8px; font-weight:500; box-shadow:0 1px 3px rgba(0,0,0,0.1); }
  .alert-bin { border-left:6px solid #e74c3c; background:#fff6f6; }
  .alert-plant { border-left:6px solid #27ae60; background:#f0fff4; }
  .alert-motion { border-left:6px solid #f39c12; background:#fff8e5; }

  canvas { background:#fff; border-radius:8px; padding:10px; box-shadow:0 2px 5px rgba(0,0,0,0.1); margin-top:10px; }

  @media(max-width:768px){
    body { padding:10px; }
    h1 { font-size:1.5rem; }
    .kpi { font-size:14px; padding:10px; }
    th, td { font-size:14px; padding:8px; }
  }
</style>
</head>
<body>

<header>
  <h1>EcoSense Dashboard</h1>
  <div class="kpi-container">
    <div class="kpi" id="kpi-users">Usuarios: â€”</div>
    <div class="kpi" id="kpi-events">Eventos: â€”</div>
    <div class="kpi" id="kpi-points">Puntos Totales: â€”</div>
  </div>
</header>

<section>
  <h2>Leaderboard Global</h2>
  <canvas id="leaderboardChart" height="100"></canvas>
</section>

<section>
  <h2>Alertas de Sensores</h2>
  <div id="sensors-alerts">Cargando...</div>
</section>

<section>
  <h2>Eventos Recientes</h2>
  <div id="events-list">Cargando...</div>
</section>

<section>
  <h2>Usuarios</h2>
  <table>
    <thead>
      <tr><th>Nombre</th><th>Email</th><th>Major/Dept</th><th>Nacionalidad/Rol</th></tr>
    </thead>
    <tbody id="users-body"><tr><td colspan="4">Cargando...</td></tr></tbody>
  </table>
</section>

<section>
  <h2>EvoluciÃ³n de Puntos</h2>
  <canvas id="pointsTimelineChart" height="100"></canvas>
</section>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<script>
// ConfiguraciÃ³n Firebase
const firebaseConfig = {
  apiKey: "AIzaSyDrlSuQYTDcSD6JTEQ-kOVo4yATvZ2zO7I",
  authDomain: "proyecto-iot---grupo-8.firebaseapp.com",
  databaseURL: "https://proyecto-iot---grupo-8-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "proyecto-iot---grupo-8",
  storageBucket: "proyecto-iot---grupo-8.firebasestorage.app",
  messagingSenderId: "739127706120",
  appId: "1:739127706120:web:29fd24907c541e311607bd"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const rootRef = db.ref('/');

// --- Charts ---
let leaderboardChart, pointsTimelineChart;

function updateLeaderboard(users, leaderboard){
  const labels = [];
  const points = [];
  Object.entries(leaderboard)
    .sort((a,b)=> b[1].points - a[1].points)
    .forEach(([uid, lb])=>{
      const name = (users && users[uid] && users[uid].name) || uid;
      labels.push(name);
      points.push(lb.points);
    });
  const ctx = document.getElementById('leaderboardChart').getContext('2d');
  if(leaderboardChart) leaderboardChart.destroy();
  leaderboardChart = new Chart(ctx,{
    type:'bar',
    data:{ labels, datasets:[{label:'Puntos', data:points, backgroundColor:'#3498db'}] },
    options:{ responsive:true, plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true } } }
  });
}

function updatePointsTimeline(users, leaderboard){
  const labels = Object.keys(users || {});
  const dataPoints = Object.keys(users || {}).map(uid => leaderboard[uid]?.points || 0);
  const ctx = document.getElementById('pointsTimelineChart').getContext('2d');
  if(pointsTimelineChart) pointsTimelineChart.destroy();
  pointsTimelineChart = new Chart(ctx,{
    type:'line',
    data:{
      labels,
      datasets:[{
        label:'Puntos',
        data:dataPoints,
        borderColor:'#e67e22',
        backgroundColor:'rgba(230,126,34,0.2)',
        tension:0.3,
        fill:true,
        pointRadius:5
      }]
    },
    options:{ responsive:true, plugins:{ legend:{ display:false } }, scales:{ y:{ beginAtZero:true } } }
  });
}

// --- Firebase listener ---
rootRef.on('value', snapshot=>{
  const data = snapshot.val() || {};

  // KPIs
  document.getElementById('kpi-users').textContent = 'Usuarios: '+ (data.users ? Object.keys(data.users).length : 0);
  document.getElementById('kpi-events').textContent = 'Eventos: '+ (data.events ? Object.keys(data.events).length : 0);
  const totalPoints = data.leaderboard ? Object.values(data.leaderboard).reduce((a,b)=>a+b.points,0) : 0;
  document.getElementById('kpi-points').textContent = 'Puntos Totales: '+ totalPoints;

  // Leaderboard grÃ¡fico
  updateLeaderboard(data.users, data.leaderboard || {});
  updatePointsTimeline(data.users, data.leaderboard || {});

  // Sensores
  const sensorsDiv = document.getElementById('sensors-alerts');
  sensorsDiv.innerHTML='';
  if(data.sensors){
    Object.entries(data.sensors).forEach(([id,s])=>{
      let div = document.createElement('div');
      div.className='alert';
      if(s.type==='plant_sensor' && s.water_needed){
        div.classList.add('alert-plant');
        div.textContent=`ðŸŒ± ${id} necesita agua!`;
      } else if(s.type==='smart_bin' && s.gas_status==='overflow'){
        div.classList.add('alert-bin');
        div.textContent=`ðŸ—‘ï¸ ${id} estÃ¡ lleno!`;
      } else if(s.type==='webcam' && s.motion_detected){
        div.classList.add('alert-motion');
        div.textContent=`ðŸŽ¥ ${id} detectÃ³ movimiento!`;
      }
      if(div.textContent) sensorsDiv.appendChild(div);
    });
  } else sensorsDiv.textContent='No hay sensores activos';

  // Eventos
  const eventsDiv = document.getElementById('events-list');
  eventsDiv.innerHTML='';
  if(data.events){
    Object.values(data.events)
      .sort((a,b)=> new Date(b.timestamp)-new Date(a.timestamp))
      .forEach(ev=>{
        const userName = (data.users && data.users[ev.user] && data.users[ev.user].name) || ev.user;
        const div = document.createElement('div');
        div.className='alert';
        div.textContent=`${ev.type} â€” ${userName} â€” +${ev.points_awarded} pts â€” ${ev.location} â€” ${new Date(ev.timestamp).toLocaleString()}`;
        eventsDiv.appendChild(div);
      });
  } else eventsDiv.textContent='No hay eventos';

  // Usuarios tabla
  const usersBody = document.getElementById('users-body');
  usersBody.innerHTML='';
  if(data.users){
    Object.values(data.users).forEach(u=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${u.name||'-'}</td><td>${u.email||'-'}</td><td>${u.major||u.department||'-'}</td><td>${u.nationality||u.role||'-'}</td>`;
      usersBody.appendChild(tr);
    });
  } else usersBody.innerHTML='<tr><td colspan="4">Sin usuarios</td></tr>';
});
</script>

</body>
</html>
