<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>EcoSense Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; max-width: 1200px; }
    header { display:flex; align-items:center; justify-content:space-between; margin-bottom:20px; }
    .kpi { display:inline-block; padding:10px 14px; border-radius:8px; box-shadow:0 1px 3px rgba(0,0,0,0.1); margin-right:10px; }
    table { width:100%; border-collapse:collapse; margin-top:12px; }
    th, td { padding:8px; border-bottom:1px solid #eee; text-align:left; }
    .alert { padding:10px; margin-bottom:8px; border-radius:6px; border-left:6px solid #d9534f; background:#fff6f6; }
  </style>
</head>
<body>
  <header>
    <h1>EcoSense Dashboard</h1>
    <div>
      <span class="kpi" id="kpi-users">Usuarios: â€”</span>
      <span class="kpi" id="kpi-events">Eventos: â€”</span>
    </div>
  </header>

  <section>
    <h2>Usuarios</h2>
    <table>
      <thead>
        <tr><th>Nombre</th><th>Email</th><th>Major/Dept</th><th>Nacionalidad/Rol</th></tr>
      </thead>
      <tbody id="users-body">
        <tr><td colspan="4">Cargando...</td></tr>
      </tbody>
    </table>
  </section>

  <section>
    <h2>Leaderboard</h2>
    <table>
      <thead><tr><th>Pos</th><th>Usuario</th><th>Puntos</th><th>Ãšltima actualizaciÃ³n</th></tr></thead>
      <tbody id="leaderboard-body">
        <tr><td colspan="4">Cargando...</td></tr>
      </tbody>
    </table>
  </section>

  <section>
    <h2>Alertas de sensores</h2>
    <div id="sensors-alerts">Cargando...</div>
  </section>

  <section>
    <h2>Eventos recientes</h2>
    <div id="events-list">Cargando...</div>
  </section>

  <!-- SDK Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <script>
    // ConfiguraciÃ³n Firebase
    const firebaseConfig = {
      apiKey: "TU_API_KEY",
      authDomain: "TU_PROYECTO.firebaseapp.com",
      databaseURL: "https://TU_PROYECTO-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "TU_PROYECTO",
      storageBucket: "TU_PROYECTO.appspot.com",
      messagingSenderId: "TU_MESSAGING_SENDER_ID",
      appId: "TU_APP_ID"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const rootRef = db.ref('/');

    rootRef.on('value', snapshot => {
      const data = snapshot.val() || {};

      // --- Render usuarios ---
      const usersBody = document.getElementById('users-body');
      usersBody.innerHTML = '';
      if (data.users) {
        Object.values(data.users).forEach(u => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${u.name || '-'}</td>
            <td>${u.email || '-'}</td>
            <td>${u.major || u.department || '-'}</td>
            <td>${u.nationality || u.role || '-'}</td>
          `;
          usersBody.appendChild(tr);
        });
        document.getElementById('kpi-users').textContent = 'Usuarios: ' + Object.keys(data.users).length;
      } else {
        usersBody.innerHTML = '<tr><td colspan="4">Sin usuarios</td></tr>';
      }

      // --- Render leaderboard ---
      const lbBody = document.getElementById('leaderboard-body');
      lbBody.innerHTML = '';
      if (data.leaderboard) {
        Object.entries(data.leaderboard)
          .sort((a,b)=> b[1].points - a[1].points)
          .forEach(([uid, lb], idx) => {
            const userName = (data.users && data.users[uid] && data.users[uid].name) || uid;
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${idx+1}</td><td>${userName}</td><td>${lb.points}</td><td>${lb.last_update}</td>`;
            lbBody.appendChild(tr);
          });
      } else {
        lbBody.innerHTML = '<tr><td colspan="4">Sin datos</td></tr>';
      }

      // --- Render sensores ---
      const sensorsDiv = document.getElementById('sensors-alerts');
      sensorsDiv.innerHTML = '';
      if (data.sensors) {
        Object.entries(data.sensors).forEach(([id, s]) => {
          let text = '';
          if (s.type === 'plant_sensor' && s.water_needed) {
            text = `ðŸŒ± ${id} necesita agua!`;
          } else if (s.type === 'smart_bin' && s.gas_status === 'overflow') {
            text = `ðŸ—‘ï¸ ${id} estÃ¡ lleno!`;
          }
          if (text) {
            const div = document.createElement('div');
            div.className = 'alert';
            div.textContent = text;
            sensorsDiv.appendChild(div);
          }
        });
      } else {
        sensorsDiv.textContent = 'Sin sensores activos';
      }

      // --- Render eventos ---
      const eventsDiv = document.getElementById('events-list');
      eventsDiv.innerHTML = '';
      if (data.events) {
        Object.values(data.events)
          .sort((a,b)=> new Date(b.timestamp) - new Date(a.timestamp))
          .forEach(ev => {
            const div = document.createElement('div');
            div.className = 'alert';
            div.textContent = `${ev.type} â€” ${ev.user} â€” +${ev.points_awarded} pts â€” ${ev.location} â€” ${new Date(ev.timestamp).toLocaleString()}`;
            eventsDiv.appendChild(div);
          });
        document.getElementById('kpi-events').textContent = 'Eventos: ' + Object.keys(data.events).length;
      } else {
        eventsDiv.textContent = 'Sin eventos';
      }
    });
  </script>
</body>
</html>
